<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Distribution System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            height: calc(100vh - 40px);
        }
        
        .task-distribution {
            width: 20%;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        
        .task-block {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: move;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            user-select: none;
        }
        
        .schedule-table {
            width: 80%;
            padding-left: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .time-cell {
            background-color: #e6f7ff;
        }
        
        .name-cell {
            background-color: #f0f0f0;
        }
        
        .drop-zone {
            min-height: 60px;
            background-color: #fff;
            position: relative;
        }
        
        .drop-zone.highlight {
            background-color: #e6ffe6;
        }
        
        .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .error {
            color: red;
            background-color: #ffe6e6;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="task-distribution" id="taskDistribution">
        <h3>Task Distribution</h3>
        <div class="loading" id="loadingTasks">Loading tasks...</div>
    </div>
    
    <div class="schedule-table">
        <h3>Schedule</h3>
        <table id="scheduleTable">
            <thead>
                <tr>
                    <th></th>
                    <th class="time-cell">9:00</th>
                    <th class="time-cell">10:00</th>
                    <th class="time-cell">11:00</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="name-cell">Albert</td>
                    <td class="drop-zone" data-row="1" data-col="1"></td>
                    <td class="drop-zone" data-row="1" data-col="2"></td>
                    <td class="drop-zone" data-row="1" data-col="3"></td>
                </tr>
                <tr>
                    <td class="name-cell">Bunyau</td>
                    <td class="drop-zone" data-row="2" data-col="1"></td>
                    <td class="drop-zone" data-row="2" data-col="2"></td>
                    <td class="drop-zone" data-row="2" data-col="3"></td>
                </tr>
                <tr>
                    <td class="name-cell">Cyril</td>
                    <td class="drop-zone" data-row="3" data-col="1"></td>
                    <td class="drop-zone" data-row="3" data-col="2"></td>
                    <td class="drop-zone" data-row="3" data-col="3"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        // 配置 - 替换为你的GAS部署URL
        const GAS_GET_TASKS_URL = 'https://script.google.com/macros/s/AKfycbzL3DSTspPVjqkmRb0fyDiA1xRxIhA5FznBAYnciuNK6-0d7JMaJ7q2VM1XikmfWPC6SQ/exec';
        const GAS_SAVE_SCHEDULE_URL = 'https://script.google.com/macros/s/AKfycbxzKLIyWiwL8QZoyYzjiIQh_NgAPVJFUgPzUzk-aaO25ntWwmlwDv74WGRg_GQaadXTvg/exec';
        
        // Task data structure
        let tasks = [];
        let draggedTask = null;
        
        // Function to generate pastel colors based on sales order
        function getPastelColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 80%)`;
        }
        
        // Function to load tasks from Google Apps Script
        async function loadTasks() {
            try {
                console.log('Loading tasks from:', GAS_GET_TASKS_URL);
                
                // 添加时间戳避免缓存
                const url = GAS_GET_TASKS_URL + '?t=' + Date.now();
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'no-cors' // 重要：GAS需要no-cors模式
                });
                
                // 由于no-cors模式，我们无法读取响应内容
                // 所以这里使用模拟数据作为后备方案
                console.log('Response status:', response.status);
                
                // 使用模拟数据进行测试
                useMockData();
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('loadingTasks').innerHTML = 
                    '<div class="error">Failed to load tasks. Using mock data.</div>';
                
                // 使用模拟数据作为后备
                useMockData();
            }
        }
        
        // 模拟数据函数
        function useMockData() {
            tasks = [
                { id: 1, clientName: 'MCD', salesOrder: 'SO-009999', itemNo: '1' },
                { id: 2, clientName: 'KFC', salesOrder: 'SO-008888', itemNo: '2' },
                { id: 3, clientName: 'BK', salesOrder: 'SO-007777', itemNo: '1' },
                { id: 4, clientName: 'PZH', salesOrder: 'SO-006666', itemNo: '3' },
                { id: 5, clientName: 'MCD', salesOrder: 'SO-009999', itemNo: '2' }
            ];
            renderTasks();
        }
        
        // Function to render tasks in the task distribution panel
        function renderTasks() {
            const taskContainer = document.getElementById('taskDistribution');
            const loadingElement = document.getElementById('loadingTasks');
            
            if (loadingElement) {
                loadingElement.remove();
            }
            
            tasks.forEach(task => {
                const taskBlock = document.createElement('div');
                taskBlock.className = 'task-block';
                taskBlock.id = `task-${task.id}`;
                taskBlock.draggable = true;
                taskBlock.style.backgroundColor = getPastelColor(task.salesOrder);
                taskBlock.textContent = `${task.clientName} (${task.salesOrder}-${task.itemNo})`;
                
                // Add drag event listeners
                taskBlock.addEventListener('dragstart', handleDragStart);
                taskBlock.addEventListener('dragend', handleDragEnd);
                
                taskContainer.appendChild(taskBlock);
            });
        }
        
        // Drag and drop functions
        function handleDragStart(e) {
            draggedTask = this;
            this.style.opacity = '0.4';
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.id);
        }
        
        function handleDragEnd(e) {
            this.style.opacity = '1';
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('highlight');
            });
        }
        
        // Drop zone event listeners
        function initializeDropZones() {
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    this.classList.add('highlight');
                });
                
                zone.addEventListener('dragleave', function() {
                    this.classList.remove('highlight');
                });
                
                zone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('highlight');
                    
                    if (draggedTask) {
                        // 检查是否已经存在任务
                        if (this.querySelector('.task-block')) {
                            if (!confirm('This slot already has a task. Replace it?')) {
                                return;
                            }
                            this.innerHTML = '';
                        }
                        
                        // 创建任务显示
                        const taskDisplay = document.createElement('div');
                        taskDisplay.className = 'task-block';
                        taskDisplay.style.backgroundColor = draggedTask.style.backgroundColor;
                        taskDisplay.textContent = draggedTask.textContent;
                        
                        // 添加删除按钮
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'remove-btn';
                        removeBtn.textContent = '×';
                        removeBtn.onclick = function() {
                            this.parentElement.remove();
                            updateScheduleData();
                        };
                        
                        taskDisplay.appendChild(removeBtn);
                        this.appendChild(taskDisplay);
                        
                        // 更新排班数据
                        updateScheduleData();
                    }
                });
            });
        }
        
        // Function to collect schedule data and send to GAS
        function updateScheduleData() {
            const scheduleData = [];
            
            document.querySelectorAll('.drop-zone').forEach(zone => {
                const row = zone.getAttribute('data-row');
                const col = zone.getAttribute('data-col');
                const taskElement = zone.querySelector('.task-block');
                
                if (taskElement) {
                    // 提取任务信息（移除×按钮文本）
                    const taskText = taskElement.textContent.replace('×', '').trim();
                    scheduleData.push({
                        row: parseInt(row),
                        col: parseInt(col),
                        task: taskText
                    });
                }
            });
            
            console.log('Saving schedule data:', scheduleData);
            saveScheduleData(scheduleData);
        }
        
        // Function to send schedule data to Google Apps Script
        async function saveScheduleData(scheduleData) {
            try {
                const response = await fetch(GAS_SAVE_SCHEDULE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({schedule: scheduleData}),
                });
                
                const result = await response.json();
                if (!result.success) {
                    console.error('Failed to save schedule:', result.error);
                } else {
                    console.log('Schedule saved successfully:', result.message);
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
            }
        }
        
        // Auto-save every 30 seconds
        setInterval(updateScheduleData, 30000);
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDropZones();
            loadTasks();
            
            // 显示配置信息（调试用）
            console.log('GAS GET URL:', GAS_GET_TASKS_URL);
            console.log('GAS SAVE URL:', GAS_SAVE_SCHEDULE_URL);
        });
    </script>
</body>
</html>
